# .github/workflows/build-test.yml
name: Build and Test OpenImpala

# Define workflow triggers
on:
  push:
    # Trigger on pushes to these specific branches
    branches:
      - master
      - working
      - build
      - 'makefile' # Include makefile branch trigger
  pull_request:
    # Trigger on Pull Requests targeting main branch
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

jobs:
  format-check:
    name: C++ Format Check (clang-format)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run clang-format check
        run: |
          find src/ tests/ -type f \( -name "*.cpp" -o -name "*.H" -o -name "*.h" -o -name "*.hpp" -o -name "*.cc" -o -name "*.cxx" -o -name "*.c" \) \
            -exec clang-format --dry-run --Werror {} +

  static-analysis:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Apptainer
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.2.5

      - name: Restore Dependency SIF Cache
        id: cache-restore-sif-tidy
        uses: actions/cache/restore@v4
        with:
          path: dependency_image.sif
          key: ${{ runner.os }}-apptainer-sif-${{ hashFiles('containers/Singularity.deps.def') }}
          restore-keys: |
            ${{ runner.os }}-apptainer-sif-

      - name: Build Dependency SIF Image (if cache miss)
        id: build_sif_tidy
        if: steps.cache-restore-sif-tidy.outputs.cache-hit != 'true'
        run: |
          sudo apptainer build --force dependency_image.sif containers/Singularity.deps.def

      - name: Run clang-tidy
        run: |
          sudo apptainer exec --writable-tmpfs --bind $PWD:/src ./dependency_image.sif \
            bash -c '
              source /opt/rh/gcc-toolset-11/enable
              dnf install -y clang-tools-extra 2>&1 | tail -3
              echo "clang-tidy version: $(clang-tidy --version 2>&1 | head -1)"
              cd /src
              ERRORS=0
              for f in $(find src/ tests/ -type f -name "*.cpp"); do
                echo "Analyzing $f..."
                clang-tidy "$f" \
                  -warnings-as-errors="*" \
                  -header-filter="src/.*" \
                  -- -std=c++17 -fopenmp -DOMPI_SKIP_MPICXX \
                  -Isrc -Isrc/io -Isrc/props \
                  -I/opt/amrex/25.03/include \
                  -I/opt/hypre/v2.32.0/include \
                  -I/opt/hdf5/1.12.3/include \
                  -I/opt/libtiff/4.6.0/include || ERRORS=$((ERRORS+1))
              done
              if [ $ERRORS -ne 0 ]; then
                echo "::error::clang-tidy found issues in $ERRORS file(s)."
                exit 1
              fi
              echo "clang-tidy passed on all files."
            '

  build-and-test-openimpala:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install Apptainer
      - name: Set up Apptainer
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.2.5

      # Step 3: Restore Dependency SIF Cache
      - name: Restore Dependency SIF Cache
        id: cache-restore-sif
        uses: actions/cache/restore@v4
        with:
          path: dependency_image.sif
          key: ${{ runner.os }}-apptainer-sif-${{ hashFiles('containers/Singularity.deps.def') }}
          restore-keys: |
            ${{ runner.os }}-apptainer-sif-

      - name: Debug cache hit status
        if: always()
        run: echo "Cache hit status is >>>${{ steps.cache-restore-sif.outputs.cache-hit }}<<<"

      # Step 4: Build Dependency SIF Image (if cache miss)
      - name: Build Dependency SIF Image Locally (if cache miss)
        id: build_sif
        if: steps.cache-restore-sif.outputs.cache-hit != 'true'
        run: |
          RECIPE_FILE="containers/Singularity.deps.def"
          TARGET_SIF="dependency_image.sif"
          if [ ! -f "$RECIPE_FILE" ]; then
            echo "Error: Dependency recipe file $RECIPE_FILE not found!"
            exit 1
          fi
          echo "Cache miss or invalid. Building dependencies SIF image '$TARGET_SIF' from $RECIPE_FILE..."
          sudo apptainer build --force "$TARGET_SIF" "$RECIPE_FILE"
          BUILD_EXIT_CODE=$?
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "Error: Apptainer SIF build failed with exit code $BUILD_EXIT_CODE."
            exit $BUILD_EXIT_CODE
          fi
          echo "Apptainer SIF build successful."
          ls -lh ./dependency_image.sif

      # Step 5: Verify SIF exists
      - name: Verify SIF exists after cache/build step
        id: verify_sif
        run: |
          if [ ! -f "./dependency_image.sif" ]; then
            echo "Error: dependency_image.sif not found after cache/build steps!"
            exit 1
          else
            echo "dependency_image.sif found."
            ls -lh ./dependency_image.sif
          fi

      - name: Copy HYPRE Check Log from Container
        if: always() && steps.verify_sif.outcome == 'success'
        run: |
          if sudo apptainer exec ./dependency_image.sif test -f /hypre_make_check.log; then
            echo "Copying /hypre_make_check.log..."
            sudo apptainer exec ./dependency_image.sif cat /hypre_make_check.log > ./hypre_make_check.log
            ls -l ./hypre_make_check.log
          else
            echo "HYPRE check log /hypre_make_check.log not found in container."
          fi
        continue-on-error: true

      - name: Upload HYPRE Check Log Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hypre-make-check-log-${{ github.run_id }}
          path: hypre_make_check.log
          retention-days: 5
          if-no-files-found: warn

      # Step 6: Save the SIF image to the cache (only if built)
      - name: Save Dependency SIF Image Cache
        if: steps.cache-restore-sif.outputs.cache-hit != 'true' && steps.build_sif.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: dependency_image.sif
          key: ${{ runner.os }}-apptainer-sif-${{ hashFiles('containers/Singularity.deps.def') }}

      # Standalone HYPRE Test (unchanged)
      - name: Verify hypre_test.cpp exists
        id: check_hypre_test_file
        run: |
          if [ ! -f ./src/props/hypre_test.cpp ]; then
            echo "::error::Standalone test file ./src/props/hypre_test.cpp not found!"
            exit 1
          else
            echo "Standalone test file ./src/props/hypre_test.cpp found."
          fi

      - name: Compile Standalone HYPRE Test
        id: compile_hypre_test
        if: steps.check_hypre_test_file.outcome == 'success'
        run: |
          echo "Compiling hypre_test.cpp inside container..."
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'source /opt/rh/gcc-toolset-11/enable && \
                     cd /src && \
                     echo "Running: mpic++ src/props/hypre_test.cpp -o hypre_test -I/opt/hypre/v2.32.0/include -L/opt/hypre/v2.32.0/lib -lHYPRE -fopenmp -lm" && \
                     mpic++ src/props/hypre_test.cpp -o hypre_test -I/opt/hypre/v2.32.0/include -L/opt/hypre/v2.32.0/lib -lHYPRE -fopenmp -lm' > compile_hypre_test.log 2>&1
          COMPILE_EXIT_CODE=$?
          cat compile_hypre_test.log
          if [ $COMPILE_EXIT_CODE -ne 0 ]; then
            echo "::error::Standalone HYPRE test compilation failed! Exit code: $COMPILE_EXIT_CODE"
            exit $COMPILE_EXIT_CODE
          fi
          echo "Standalone HYPRE test compilation successful."
          ls -l ./hypre_test

      - name: Run Standalone HYPRE Test (Direct Output)
        id: run_hypre_test
        if: steps.compile_hypre_test.outcome == 'success'
        continue-on-error: true
        run: |
          echo "Running hypre_test inside container (logging directly)..."
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'source /opt/rh/gcc-toolset-11/enable && \
                     cd /src && \
                     echo "Executing: mpirun -np 1 --allow-run-as-root ./hypre_test 2>&1" && \
                     mpirun -np 1 --allow-run-as-root ./hypre_test 2>&1'
          RUN_EXIT_CODE=$?
          echo "Standalone HYPRE test execution finished with exit code: $RUN_EXIT_CODE"
          echo "exit_code=$RUN_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check Standalone Test Outcome
        if: steps.run_hypre_test.outcome == 'failure' || steps.run_hypre_test.outputs.exit_code != '0'
        run: |
          echo "::error::Standalone HYPRE test execution failed (Exit Code: ${{ steps.run_hypre_test.outputs.exit_code }}). See output above."
          echo "::warning::Standalone HYPRE test failed, but continuing workflow..."

      # Step 7: Build OpenImpala with CMake inside the Dependency SIF
      - name: Build OpenImpala (CMake)
        id: cmake_build
        continue-on-error: true
        run: |
          echo "Configuring and building OpenImpala with CMake..."
          sudo apptainer exec \
            --writable-tmpfs \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'source /opt/rh/gcc-toolset-11/enable && \
                     cd /src && \
                     rm -rf cmake_build && mkdir cmake_build && cd cmake_build && \
                     cmake3 .. \
                       -DCMAKE_BUILD_TYPE=Release \
                       -DCMAKE_C_COMPILER=$(which mpicc) \
                       -DCMAKE_CXX_COMPILER=$(which mpicxx) \
                       -DCMAKE_Fortran_COMPILER=$(which mpif90) \
                       -DCMAKE_PREFIX_PATH="/opt/amrex/25.03;/opt/hypre/v2.32.0;/opt/hdf5/1.12.3;/opt/libtiff/4.6.0" \
                       -DBUILD_TESTING=ON && \
                     make -j$(nproc)' > cmake_build_output.log 2>&1
          CMAKE_EXIT_CODE=$?
          echo "CMake build exit code: $CMAKE_EXIT_CODE"
          exit $CMAKE_EXIT_CODE

      # Step 8: Upload Build Log
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cmake-build-log-${{ github.run_id }}
          path: cmake_build_output.log
          retention-days: 5
          if-no-files-found: warn

      # Step 9: Fail if build failed
      - name: Check build outcome
        if: steps.cmake_build.outcome == 'failure'
        run: |
          echo "CMake build failed. See uploaded 'cmake-build-log' artifact for details."
          cat cmake_build_output.log || true
          exit 1

      # Step 9.5: Check Test TIFF File Before Running Tests
      - name: Check Test TIFF File Status Inside Container
        if: steps.cmake_build.outcome == 'success'
        run: |
          echo "Checking status of data/SampleData_2Phase_stack_3d_1bit.tif inside container..."
          TARGET_FILE="data/SampleData_2Phase_stack_3d_1bit.tif"
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c "cd /src && \
                     echo '--- Running ls -l:' && \
                     ls -l \"${TARGET_FILE}\" && \
                     echo '--- Running file command:' && \
                     file \"${TARGET_FILE}\" && \
                     echo '--- Running tiffinfo:' && \
                     tiffinfo \"${TARGET_FILE}\"" || echo "::warning::Checking test file failed, proceeding anyway..."
          echo "Finished checking test file status."
        continue-on-error: true

      # Step 10: Run Tests with CTest
      - name: Run Tests (CTest)
        id: ctest_run
        if: steps.cmake_build.outcome == 'success'
        continue-on-error: true
        run: |
          echo "Running ctest..."
          timeout 1200 sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'source /opt/rh/gcc-toolset-11/enable && \
                     cd /src/cmake_build && \
                     ctest --output-on-failure --timeout 300' > ctest_output.log 2>&1
          TEST_EXIT_CODE=$?
          if [ $TEST_EXIT_CODE -eq 124 ]; then
              echo "::error::Test step timed out after 20 minutes!"
          fi
          echo "CTest exit code: $TEST_EXIT_CODE"

          # Attempt to copy Backtrace files
          echo "Attempting to find and copy Backtrace files..."
          sudo apptainer exec \
            --bind $PWD:/src \
            ./dependency_image.sif \
            bash -c 'find /src -maxdepth 2 -name "Backtrace.*" -exec echo "==> Found Backtrace file:" {} \; -exec cp {} /src/ \;' || true

          exit $TEST_EXIT_CODE

      # Step 11: Upload Test Log and Backtrace
      - name: Upload Test Log and Backtrace Artifacts
        if: always() && steps.cmake_build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ctest-output-${{ github.run_id }}
          path: |
            ctest_output.log
            Backtrace.*
          retention-days: 5
          if-no-files-found: warn

      # Step 12: Fail if tests failed
      - name: Check test outcome
        if: steps.cmake_build.outcome == 'success' && steps.ctest_run.outcome == 'failure'
        run: |
          echo "CTest failed. See uploaded 'ctest-output' artifact for details."
          cat ctest_output.log || true
          exit 1
